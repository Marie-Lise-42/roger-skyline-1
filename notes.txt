###################### Feb, 20th 2020 ########################
######################### TEST14: ##################################
##################### CREER LA VM #################################
New
name: TEST14
Machine folder: /sgoinfre/goinfre/Perso/manki/VirtualBox VMs
Type: Linux
Version: Debian (64-bits)

Memory size 4096MB

Create a virtual hard disk now

VDI (Virtual Hard Disk Image)

Fixed size

8.00GB (I didn't change the path of the .vdi file)

2 min wait => once finished, do not start the VM before changing the settings:

		Settings
generals:
	Shared Clipboard: Bi-derectional
	Drag and drop : Bi directional
System:
	System->Floppy-> uncheck
	Processor : 4CPU
	Storage => in Storage Devices click on empty, then in Attributes, click
on the blue circle next to optical drive, and choose debian-10.1.0-amd64-netinst.iso
	Network->Adapter 1-> attached to: Bridge Adapter
	Shared Folder: creer des dossier partage entre la VM et ma session

START the VM and click on Install
Select a language : French
Situation Geographique : France
clavier : Etats-Unis
Nom de machine : test14
Domaine : <empty>
Creer les utilisateurs et choisir les mot de passe :
mdp root : 1234
nom complet du nouvel utilisateur : Myriam
id user : manki
mdp user : manki

Partitionnement assiste->manuel :
	click on SCSI3(0,0,0)(sda)...
	faut-il creer une nouvelle table des partitions sur ce disque ? oui
	click on pri/log 8.6 GB Espace Libre => creer une nouvelle partition
		=> 4.6GB, Primaire, emplacement: Debut, utiliser comme: systeme
		de fichiers ext2, point de montage /, fin du paramettrage de
		cette partition
	click on pri/log 4.0 GB Espace Libre => creer une nouvelle partition
		=> 4.0GB, Logique,  utiliser comme: espace d'echange swap,
		fin du paramettrage de cette partition
	Terminer le Partitionnement et appliquer les changements
	Faut-il appliquer les changement sur les disques => oui

Analyser un autre cd -> non
France
Debian archive mirror: ftp.fr.debian.org
mandataire http : <leave empty>
Participer a l'etude, non
Selection des logiciels :
	- serveur ssh
	- utilitaires usuels du systeme
Installer GRUB : oui
dans /dev/sta...
	fin d'installation du systeme

test14 login : manki
Password: manki
############################### FIN CREATION VM ##############################

############################ PARAMETTRER LA VM ###############################

su (to be super user root)
	mdp : 1234
Update:
	apt-get -y update && apt-get -y upgrade

Install packages:
	apt-get install -y sudo git apache2 sendmail fail2ban vim

Install folder:
	cd /root
	git clone https://github.com/IMBiXx/Roger-Skyline.git /root/roger-skyline

user creation:
	echo "Adding sudo user... Username ? (default: 'roger')"
	read Username
	Username=${Username:-"roger"}
	sudo adduser $Username
	sudo adduser $Username sudo
	sudo vim /etc/sudoers
		add "$Username     ALL=(ALL:ALL) NOPASSWD:ALL" after root


interfaces:
	cp /etc/network/interfaces /etc/network/interfaces_save
	rm -f /etc/network/interfaces
	cp /root/roger-skyline/files/interfaces /etc/network
	cp /root/roger-skyline/files/enp0s3 /etc/network/interfaces.d/
	sudo service networking restart

sshd config:
	cp /etc/ssh/sshd_config /etc/ssh/sshd_config_save
	rm -rf /etc/ssh/sshd_config
	cp /root/roger-skyline/files/sshd_config /etc/ssh/
	mkdir -pv /home/$Username/.ssh
	cat /root/roger-skyline/files/id_rsa.pub >> /home/$Username/.ssh/authorized_keys
	/etc/init.d/ssh restart

Firewall:
	sh /root/roger-skyline/scripts/firewall.sh

DDOS Protection:
	sh /root/roger-skyline/scripts/ports.sh

making the configuration persistent:
	apt-get install -y iptables-persistent

mail server:
	yes 'Y' | sudo sendmailconfig

update script:
	mkdir /root/scripts
	cp /root/roger-skyline/scripts/script_log.sh /root/scripts/
	chmod 755 /root/scripts/script_log.sh
	chown root /root/scripts/script_log.sh

	echo "0 4 * * wed root /root/scripts/script_log.sh\n" >> /etc/crontab
	echo "@reboot root /root/scripts/script_log.sh\n" >> /etc/crontab

	echo "0 4 * * wed root /root/scripts/script_log.sh\n" >> /var/spool/cron/crontabs/root
	echo "@reboot root /root/scripts/script_log.sh\n" >> /var/spool/cron/crontabs/root

crontab script:
	cp /root/roger-skyline/scripts/script_crontab.sh /root/scripts/
	cp /root/roger-skyline/files/mail_type.txt /root/scripts/
	chmod 755 /root/scripts/script_crontab.sh
	chown root /root/scripts/script_crontab.sh
	chown root /root/scripts/mail_type.txt

	echo "0 0 * * * root /root/scripts/script_crontab.sh\n" >> /etc/crontab
	echo "0 0 * * * root /root/scripts/script_crontab.sh\n" >> /var/spool/cron/crontabs/root

	cat /etc/crontab > /root/scripts/tmp

web server:
	systemctl start apache2

virtual host:
	mkdir -p /var/www/init.login.fr/html
	chown -R $Username:$Username /var/www/init.login.fr/html
	chmod -R 775 /var/www/init.login.fr

	cp /root/roger-skyline/files/index.html /var/www/init.login.fr/html/
	cp -r /root/roger-skyline/files/assets /var/www/init.login.fr/html/

	cp /root/roger-skyline/files/init.login.fr.conf /etc/apache2/sites-available/

	rm /etc/apache2/sites-enabled/000-default.conf
	ln -s /etc/apache2/sites-available/init.login.fr.conf /etc/apache2/sites-enabled/

ssl certificat:
	cd /etc/ssl/certs/
	openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout roger.key -out roger.crt

	sudo a2enmod ssl
	sudo service apache2 restart

cleaning:
	apt-get remove -y git
	rm -rf /root/roger-skyline/
	echo "Subject: Install done for $Username." | sudo sendmail -v manki@student.42.fr

############################ FIN DES PARAMETTRAGE ############################

########################### COMMANDES UTILES #################################

sudo fdisk -l => debian disk infos

sudo vim /etc/sudoers : pour configurer les sudo users

sudo vim /etc/network/interfaces => to configure a static IP address.
